def call() {

    //Map opts = [:]
    //opts.jenkinsNode = 'Windows'
    
    pipeline {
        agent {
            // Which Jenkins node to build on
            label 'windows'
        }

        options {
            // Colorize the terminal output
            ansiColor('xterm')
            // the build should never take this long
            timeout(time: 1, unit: 'HOURS')
            // add timestamps to log output
            timestamps()
            // disable parallel buildchain
            disableConcurrentBuilds()
        }

        stages {
            stage('Initialise') {
                steps {
                    cleanWs()
                    checkout scm
                }
            }
            stage('Build dotnet') {
                steps {
                    script { 

                        env.SONAR_SCANNER_NET = tool 'sonarscanner-net'

                        withSonarQubeEnv('sonar.local') {
                            pwsh(script: '''
                                dotnet $env:SONAR_SCANNER_NET/SonarScanner.MSBuild.dll begin /k:"dotnet-application"
                            ''')
                        }

                        pwsh(script: '''
                            dotnet restore
                            dotnet clean
                            dotnet build -c Release --no-restore
                        ''')

                        pwsh(script: '''
                            dotnet test -c Release --results-directory:$env:WORKSPACE/Test_Results --collect 'Code Covarage'
                        ''')

                        withSonarQubeEnv('sonar.local') {
                            pwsh(script: '''
                                dotnet $env:SONAR_SCANNER_NET/SonarScanner.MSBuild.dll end
                            ''')
                        }
                        
                        pwsh(script: 'ls')
                        
                        /*timeout(time: 10, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: false
                        }*/

                    }
                }
            }
        }
    }
}

call()
